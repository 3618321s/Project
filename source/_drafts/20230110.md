---
title: ASP.Net GridView自訂取得資料及排序
date: 2023-01-10 15:21:19
categories:
  - ASP.NET
tags:
  - GridView
---

ASP.Net 經常使用的GridView
自訂取得資料方式
<!--more-->

## aspx

```
        //轉換成TemplateField
        <asp:GridView ID="GridView1" runat="server" AutoGenerateColumns="False" DataKeyNames="No_ID">
            <Columns>
                <asp:TemplateField HeaderText="No_ID" SortExpression="No_ID">
                    <EditItemTemplate>
                        <asp:Label ID="Label1" runat="server" Text='<%# Eval("No_ID") %>'></asp:Label>
                    </EditItemTemplate>
                    <ItemTemplate>
                        <asp:Label ID="Label1" runat="server" Text='<%# Bind("No_ID") %>'></asp:Label>
                    </ItemTemplate>
                </asp:TemplateField>
                <asp:TemplateField HeaderText="ID" SortExpression="ID">
                    <EditItemTemplate>
                        <asp:TextBox ID="TextBox1" runat="server" Text='<%# Bind("ID") %>'></asp:TextBox>
                    </EditItemTemplate>
                    <ItemTemplate>
                        <asp:Label ID="Label2" runat="server" Text='<%# Bind("ID") %>'></asp:Label>
                    </ItemTemplate>
                </asp:TemplateField>
                <asp:TemplateField HeaderText="PN" SortExpression="PN">
                    <EditItemTemplate>
                        <asp:TextBox ID="TextBox2" runat="server" Text='<%# Bind("PN") %>'></asp:TextBox>
                    </EditItemTemplate>
                    <ItemTemplate>
                        <asp:Label ID="Label3" runat="server" Text='<%# Bind("PN") %>'></asp:Label>
                    </ItemTemplate>
                </asp:TemplateField>               
            </Columns>
        </asp:GridView>
```

## cs

```
    ///宣告
    protected string conn = ConfigurationManager.ConnectionStrings["資料庫連結名稱"].ConnectionString;   
    private SqlConnection connection;
    private SqlCommand cmd;
    private SqlDataAdapter adapter;
    private DataTable dt;
    protected void Page_Load(object sender, EventArgs e)
    {
        if (!IsPostBack)//Get Method進來
        {
            connection = new SqlConnection(conn);
            cmd = new SqlCommand();
            cmd.Connection = connection;
            GVGetData();
        }
    }
    /// <summary>
    /// 取得資料
    /// </summary>
    private DataTable GetData()
    {
        dt = new DataTable();
        string queryString = "SQL語法(資料庫顯示內容)"; //需要修改處
        cmd = new SqlCommand(queryString, connection);
        adapter = new SqlDataAdapter(cmd);
        adapter.Fill(dt);
        return dt;
    }
    /// <summary>
    /// 取得資料
    /// </summary>
    private void GVGetData()
    {
        DataTable _dt;

        if (ViewState["se"] == null)
        {
            _dt = GetData();
            GridView1.DataSource = _dt;
            GridView1.DataBind();
        }
        else
        {
            string se = Convert.ToString(ViewState["se"]);
            SortDirection sd = (SortDirection)ViewState["sd"];
            this.GVGetData(sd, se);
        }
    }
    /// <summary>
    /// 取得排序資料
    /// </summary>
    private void GVGetData(SortDirection pSortDirection,
        string pSortExpression)
    {
        DataTable _dt = GetData();

        string sSort = string.Empty;
        if (pSortDirection == SortDirection.Ascending)
        {
            sSort = pSortExpression;
        }
        else
        {
            sSort = string.Format("{0} {1}", pSortExpression, "DESC");
        }

        DataView dv = _dt.DefaultView;
        dv.Sort = sSort;

        GridView1.DataSource = dv;
        GridView1.DataBind();
    }
    /// <summary>
    /// 排序
    /// </summary>
    protected void gv_Sorting(object sender, GridViewSortEventArgs e)
    {
        string se = ViewState["se"] != null ?
        Convert.ToString(ViewState["se"]) : string.Empty;
        SortDirection sd = ViewState["sd"] != null ?
            (SortDirection)ViewState["sd"] : SortDirection.Ascending;

        if (string.IsNullOrEmpty(se))
        {
            se = e.SortExpression;
            sd = SortDirection.Ascending;
        }

        // 如果欄位與本來不同
        if (se != e.SortExpression)
        {
            // 切換為目前所指定欄位
            se = e.SortExpression;

            // 指定排列方式為升冪
            sd = SortDirection.Ascending;
        }
        // 如果欄位與本來相同
        else
        {
            // 切換升冪為降冪，降冪為升冪
            if (sd == SortDirection.Ascending)
                sd = SortDirection.Descending;
            else
                sd = SortDirection.Ascending;
        }

        // 紀錄欄位與排列方式 ( 升冪或降冪 )
        ViewState["se"] = se;
        ViewState["sd"] = sd;

        GVGetData(sd, se);
    } 
```


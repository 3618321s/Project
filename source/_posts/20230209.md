---
title: GridView 新增、編輯、刪除、換頁
date: 2023-02-09 11:36:07
tags:
  - GridView
categories:
  - ASP.NET
---

上一篇 GridView 取得資料及排序

這篇紀錄如何新增、編輯、刪除、換頁

<!--more-->
## aspx
### GridView 設定事件
```
    OnRowEditing="gv_RowEditing"  
    OnRowCancelingEdit="gv_RowCancelingEdit" 
    OnRowUpdating="gv_RowUpdating" 
    OnRowDeleting="gv_RowDeleting"     
    OnPageIndexChanging="gv_PageIndexChanging" 
    OnRowCreated="gv_RowCreated"
```
![Image](https://github.com/3618321s/blog/raw/gh-pages/images/Project/GridView事件.jpg)

## C#
### 
```
    //編輯資料
    protected void gv_RowEditing(object sender, GridViewEditEventArgs e)
    {
        gv.EditIndex = e.NewEditIndex;

        GVGetData();
    }

    //取消編輯
    protected void gv_RowCancelingEdit(object sender, GridViewCancelEditEventArgs e)
    {
        gv.EditIndex = -1;

        GVGetData();
    }

    //更新資料
    protected void gv_RowUpdating(object sender, GridViewUpdateEventArgs e)
    {
        string sqlString = "SQL語法";
        string MODI_IP, MODI_USER, MODI_AP, MODI_DATE, MODI_TIME, MODI_WEB, MT002, MT006, MT007;

        MODI_IP = HttpContext.Current.Request.UserHostAddress;
        MODI_USER = lbuser.Text;
        MODI_AP = System.Net.Dns.GetHostName();
        MODI_DATE = DateTime.Now.ToString("yyyyMMdd");
        MODI_TIME = DateTime.Now.ToString("HH:mm:ss");
        MODI_WEB = "作業名";
        MT002 = ((Label)gv.Rows[e.RowIndex].Cells[0].
            FindControl("控制項ID")).Text;        
        MT006 = ((TextBox)gv.Rows[e.RowIndex].Cells[0].
            FindControl("控制項ID")).Text;
        MT007 = ((DropDownList)gv.Rows[e.RowIndex].Cells[0].
            FindControl("控制項ID")).Text;        
        using (SqlConnection connection = new SqlConnection(conn))
        {
            connection.Open();
            var cmd = new SqlCommand(sqlString, connection);
            cmd.Parameters.AddWithValue("MODI_IP", MODI_IP);
            cmd.Parameters.AddWithValue("MODI_USER", MODI_USER);
            cmd.Parameters.AddWithValue("MODI_AP", MODI_AP);
            cmd.Parameters.AddWithValue("MODI_DATE", MODI_DATE);
            cmd.Parameters.AddWithValue("MODI_TIME", MODI_TIME);
            cmd.Parameters.AddWithValue("MODI_WEB", MODI_WEB);
            cmd.Parameters.AddWithValue("MT002", MT002);            
            cmd.Parameters.AddWithValue("MT006", MT006);
            cmd.Parameters.AddWithValue("MT007", MT007);            
            try
            {
                cmd.ExecuteNonQuery();
                Response.Write("<script>alert('資料儲存成功！')</script>");
            }
            catch (Exception)
            {
                Response.Write("<script>alert('資料儲存失敗！')</script>");
            }
            finally
            {
                connection.Close();
            }
            gv.EditIndex = -1;

            GVGetData();
            Response.AddHeader("Refresh", "0"); //刷新頁面
        }
    }

    //刪除資料 目前不使用
    protected void gv_RowDeleting(object sender, GridViewDeleteEventArgs e)
    {
        string sqlstr = "SQL語法"; 
        string No_ID = ((Label)GridView1.Rows[e.RowIndex].FindControl("Label1")).Text;        

        using (SqlConnection connection = new SqlConnection(conn))
        {
            connection.Open();
            var cmd = new SqlCommand(sqlstr, connection);
            cmd.Parameters.AddWithValue("No_ID", No_ID);
            try
            {
                cmd.ExecuteNonQuery();                
            }
            catch (Exception)
            {
                
            }
            finally
            {
                connection.Close();
            }
        }        
        GVGetData();
    }

    //換頁
    protected void gv_PageIndexChanging(object sender, GridViewPageEventArgs e)
    {
        //gv.PageIndex = e.NewPageIndex;        
        GridView GridView1w = (GridView)sender;
        if (e.NewPageIndex < 0)
        {
            
        }
        else
        {
            GridView1w.PageIndex = e.NewPageIndex;
        }
        GVGetData();
    }

    //分頁 數字頁面
    protected void gv_RowCreated(object sender, GridViewRowEventArgs e)
    {
        if (e.Row.RowType == DataControlRowType.Pager)
        {
            // 取得控制項
            GridView gv = sender as GridView;
            PlaceHolder phdPageNumber = e.Row.FindControl("phdPageNumber") as PlaceHolder;
            LinkButton lbtnPage;

            // 產生頁數
            int showRange = 8;
            int pageCount = gv.PageCount;
            int pageIndex = gv.PageIndex;
            int startIndex = (pageIndex + 1 < showRange) ?
                0 : (pageIndex + 1 + showRange / 2 >= pageCount) ? pageCount - showRange : pageIndex - showRange / 2;
            int endIndex = (startIndex >= pageCount - showRange) ? pageCount : startIndex + showRange;

            phdPageNumber.Controls.Add(new LiteralControl("  "));
            for (int i = startIndex; i < endIndex; i++)
            {
                lbtnPage = new LinkButton();
                lbtnPage.Text = (i + 1).ToString();
                lbtnPage.CommandName = "Page";
                lbtnPage.CommandArgument = (i + 1).ToString();
                lbtnPage.Font.Overline = false;
                if (i == pageIndex)
                    lbtnPage.Font.Bold = true;
                else
                    lbtnPage.Font.Bold = false;
                phdPageNumber.Controls.Add(lbtnPage);
                phdPageNumber.Controls.Add(new LiteralControl(" "));
            }
        }
    }
```
下一篇 GridView 額外使用方式
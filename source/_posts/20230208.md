---
title: GridView 取得資料及排序
date: 2023-02-09 11:35:56
tags:
  - GridView
categories:
  - ASP.NET
---

經常使用到GridView
整理經常使用方式
記錄下來

先記錄如何取得資料

<!--more-->
## aspx
### GridView
```
    <asp:GridView ID="GridView1" runat="server" AutoGenerateColumns="False" OnSorting="gv_Sorting"
        HorizontalAlign="Center" BackColor="#DDDDDD" BorderStyle="None" CssClass="gvStyle" 
        BorderWidth="1px" CellPadding="5" CellSpacing="1" GridLines="None" PageSize="50"
        Style="line-height: 28px; width: 100%;" AllowPaging="True" AllowSorting="True" DataKeyNames="UR002">
        <RowStyle BackColor="#DEF0F7" HorizontalAlign="center" />
        <FooterStyle BackColor="#CCCC99" HorizontalAlign="Center" />
        <PagerStyle BackColor="#FFFFFF" HorizontalAlign="Center" Font-Size="Small" ForeColor="Black" />
        <HeaderStyle BackColor="#6B696B" Font-Bold="True" HorizontalAlign="center" ForeColor="White" />
        <AlternatingRowStyle BackColor="White" HorizontalAlign="Center" />
        <EmptyDataTemplate>
            Sorry, No any data.
        </EmptyDataTemplate>
        <Columns>
            <asp:TemplateField>
                <HeaderTemplate>
                    <asp:LinkButton ID="lbInsert" runat="server" Width="70px"></asp:LinkButton>
                </HeaderTemplate>
                <ItemTemplate>
                    <asp:LinkButton ID="lbEdit" runat="server"
                        CommandName="Edit">編輯</asp:LinkButton>
                    |
                <asp:LinkButton ID="lbDelete" runat="server"
                    OnClientClick="javascript:return confirm('確定刪除?')"
                    CommandName="Delete">刪除</asp:LinkButton>
                </ItemTemplate>
                <EditItemTemplate>
                    <asp:LinkButton ID="lbUpdate" runat="server"
                        CommandName="Update">更新</asp:LinkButton>
                    |
                <asp:LinkButton ID="lbCancelUpdate" runat="server"
                    CommandName="Cancel">取消</asp:LinkButton>
                </EditItemTemplate>
            </asp:TemplateField>            
            <asp:TemplateField HeaderText="欄位標題" SortExpression="資料表欄位名">
                <EditItemTemplate>
                    <asp:Label ID="Label1" runat="server" Text='<%# Eval("資料表欄位名") %>'></asp:Label>
                </EditItemTemplate>
                <ItemTemplate>
                    <asp:Label ID="Label2" runat="server" Text='<%# Eval("資料表欄位名") %>'></asp:Label>
                </ItemTemplate>
            </asp:TemplateField>            
            <asp:TemplateField HeaderText="欄位標題" SortExpression="資料表欄位名">
                <EditItemTemplate>
                    <asp:DropDownList ID="DropDownList1" runat="server" SelectedValue='<%# Bind("資料表欄位名") %>' AutoPostBack="True">
                        <asp:ListItem Value="0">未登入</asp:ListItem>
                        <asp:ListItem Value="1">已登入</asp:ListItem>
                        <asp:ListItem Value="2">已鎖定</asp:ListItem>                        
                    </asp:DropDownList>
                </EditItemTemplate>
                <ItemTemplate>
                    <asp:Label ID="Label3" runat="server" Text='<%# Eval("資料表欄位名") %>'></asp:Label>
                </ItemTemplate>
            </asp:TemplateField>
            <asp:TemplateField HeaderText="欄位標題" SortExpression="資料表欄位名">
                <EditItemTemplate>
                    <asp:TextBox ID="TextBox1" runat="server" Text='<%# Bind("資料表欄位名") %>'></asp:TextBox>
                </EditItemTemplate>
                <ItemTemplate>
                    <asp:Label ID="Label4" runat="server" Text='<%# Eval("資料表欄位名") %>'></asp:Label>
                </ItemTemplate>
                <ItemStyle Width="500px" /><%------->欄位寬度調整--%>
            </asp:TemplateField>
        </Columns>
        <SelectedRowStyle BackColor="#CE5D5A" Font-Bold="True" ForeColor="White" />
        <SortedAscendingCellStyle BackColor="#FBFBF2" />
        <SortedAscendingHeaderStyle BackColor="#848384" />
        <SortedDescendingCellStyle BackColor="#EAEAD3" />
        <SortedDescendingHeaderStyle BackColor="#575357" />
        <PagerTemplate>
            <table>
                <tr>
                    <td style="text-align: right">第&nbsp;<asp:Label ID="lblPageIndex" runat="server" Text="<%#((GridView)Container.Parent.Parent).PageIndex + 1 %>" ForeColor="#0b6f96"></asp:Label>&nbsp;頁，
                                共&nbsp;<asp:Label ID="lblPageCount" runat="server" Text="<%# ((GridView)Container.Parent.Parent).PageCount %>" ForeColor="#0b6f96"></asp:Label>&nbsp;頁，
                                <asp:LinkButton ID="btnFirst" runat="server" CausesValidation="False" CommandArgument="First" CommandName="Page" Text="第一頁"></asp:LinkButton>&nbsp;&nbsp;
                                <asp:LinkButton ID="btnPrev" runat="server" CausesValidation="False" CommandArgument="Prev" CommandName="Page" Text="上一頁"></asp:LinkButton>&nbsp;&nbsp;
                                <asp:LinkButton ID="btnNext" runat="server" CausesValidation="False" CommandArgument="Next" CommandName="Page" Text="下一頁"></asp:LinkButton>&nbsp;&nbsp;
                                <asp:LinkButton ID="btnLast" runat="server" CausesValidation="False" CommandArgument="Last" CommandName="Page" Text="最後一頁"></asp:LinkButton>&nbsp;&nbsp;
                                <%--<asp:TextBox ID="txtNewPageIndex" runat="server" Text="<%# ((GridView)Container.Parent.Parent).PageIndex + 1%>" Width="120px"></asp:TextBox>
                        <asp:LinkButton ID="btnGo" runat="server" CausesValidation="False" CommandArgument="-1" CommandName="Page" Text="GO"></asp:LinkButton>--%>
                    </td>
                </tr>
            </table>
        </PagerTemplate>
    </asp:GridView>
```

## C#
### 引用
```
using System.Data;
using System.Data.SqlClient;
using System.Configuration;
```
### 宣告
```
    string conn = ConfigurationManager.ConnectionStrings["SQL連結名稱"].ConnectionString;
    private SqlConnection connection;
    private SqlCommand cmd;
    private SqlDataAdapter adapter;
    private DataTable dt;
```
### 取得資料(基本)
```
    protected void Page_Load(object sender, EventArgs e)
    {        
        connection = new SqlConnection(conn);
        cmd = new SqlCommand();
        cmd.Connection = connection;
        if (!IsPostBack)
        {
            GvGetData();
        }
        else
        {
            return;
        }
    }

    //取得資料
    private DataTable GetData()
    {
        dt = new DataTable();
        string queryString = "SQL語法"; //資料呈現
        cmd = new SqlCommand(queryString, connection);
        adapter = new SqlDataAdapter(cmd);
        adapter.Fill(dt);
        return dt;
    }

    //取得資料
    private void GvGetData()
    {
        DataTable _dt;

        if (ViewState["se"] == null)
        {
            _dt = GetData();
            GridView1.DataSource = _dt;
            GridView1.DataBind();
        }
        else
        {
            string se = Convert.ToString(ViewState["se"]);
            SortDirection sd = (SortDirection)ViewState["sd"];
            this.GVGetData(sd, se);
        }
    }
    //取得排序資料
    private void GVGetData(SortDirection pSortDirection, string pSortExpression)
    {
        DataTable _dt = GetData();

        string sSort = string.Empty;
        if (pSortDirection == SortDirection.Ascending)
        {
            sSort = pSortExpression;
        }
        else
        {
            sSort = string.Format("{0} {1}", pSortExpression, "DESC");
        }

        DataView dv = _dt.DefaultView;
        dv.Sort = sSort;

        GridView1.DataSource = dv;
        GridView1.DataBind();
    }
    //排序
    protected void gv_Sorting(object sender, GridViewSortEventArgs e)
    {
        string se = ViewState["se"] != null ?
        Convert.ToString(ViewState["se"]) : string.Empty;
        SortDirection sd = ViewState["sd"] != null ?
            (SortDirection)ViewState["sd"] : SortDirection.Ascending;

        if (string.IsNullOrEmpty(se))
        {
            se = e.SortExpression;
            sd = SortDirection.Ascending;
        }

        // 如果欄位與本來不同
        if (se != e.SortExpression)
        {
            // 切換為目前所指定欄位
            se = e.SortExpression;

            // 指定排列方式為升冪
            sd = SortDirection.Ascending;
        }
        // 如果欄位與本來相同
        else
        {
            // 切換升冪為降冪，降冪為升冪
            if (sd == SortDirection.Ascending)
                sd = SortDirection.Descending;
            else
                sd = SortDirection.Ascending;
        }

        // 紀錄欄位與排列方式 ( 升冪或降冪 )
        ViewState["se"] = se;
        ViewState["sd"] = sd;

        GVGetData(sd, se);
    }   
```
#### 使用SQL語法取得資料
```
//取得資料
    private DataTable GetData()
    {
        dt = new DataTable();
        string queryString = "SQL語法"; //資料呈現
        cmd = new SqlCommand(queryString, connection);
        cmd.Parameters.AddWithValue("@參數", 參數); //SQL語法中需使用到的參數
        adapter = new SqlDataAdapter(cmd);
        adapter.Fill(dt);
        return dt;
    }
```
#### 使用預存程序取得資料

```
    private DataTable GvData()
    {
        dt = new DataTable();
        queryString = "MCS_Setting"; //預存程序名稱
        cmd = new SqlCommand(queryString, connection);
        cmd.CommandType = CommandType.StoredProcedure; //指定使用預存程序
        cmd.Parameters.AddWithValue("@參數", 參數); //SQL語法中需使用到的參數    
        adapter = new SqlDataAdapter(cmd);
        adapter.Fill(dt);
        return dt;
    }
```
下一篇寫新增、編輯、刪除、換頁。